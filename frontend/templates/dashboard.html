<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Core Tech Africa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .page-section:not(.active) {
            display: none;
        }

        .nav-btn.active {
            background-color: #dbeafe; /* bg-blue-100 */
            color: #2563eb; /* text-blue-600 */
        }
        
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="flex flex-col md:flex-row h-screen">
        <nav class="bg-white shadow-lg p-6 flex flex-col items-center md:items-start space-y-4 md:w-64">
            <div class="logo-section flex items-center space-x-2 mb-8">
                <i class="fa-solid fa-droplet text-blue-500 text-3xl"></i>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Core Tech Africa</h1>
                    <p class="text-sm text-gray-500">Smart Water Management</p>
                </div>
            </div>
            
            <a href="#overview" class="nav-btn active w-full py-3 px-4 rounded-lg flex items-center space-x-4 text-gray-700 hover:bg-blue-100 hover:text-blue-600 transition-colors duration-200" data-page="overview">
                <i class="fa-solid fa-chart-bar text-lg"></i>
                <span class="font-medium hidden md:block">Overview</span>
            </a>
            <a href="#payments" class="nav-btn w-full py-3 px-4 rounded-lg flex items-center space-x-4 text-gray-700 hover:bg-blue-100 hover:text-blue-600 transition-colors duration-200" data-page="payments">
                <i class="fa-solid fa-credit-card text-lg"></i>
                <span class="font-medium hidden md:block">Payments</span>
            </a>
            <a href="#usage" class="nav-btn w-full py-3 px-4 rounded-lg flex items-center space-x-4 text-gray-700 hover:bg-blue-100 hover:text-blue-600 transition-colors duration-200" data-page="usage">
                <i class="fa-solid fa-droplet text-lg"></i>
                <span class="font-medium hidden md:block">Usage</span>
            </a>
            <a href="#settings" class="nav-btn w-full py-3 px-4 rounded-lg flex items-center space-x-4 text-gray-700 hover:bg-blue-100 hover:text-blue-600 transition-colors duration-200" data-page="settings">
                <i class="fa-solid fa-gear text-lg"></i>
                <span class="font-medium hidden md:block">Settings</span>
            </a>
        </nav>

        <main class="flex-1 p-6 overflow-y-auto">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                <div class="flex items-center space-x-4">
                    <div class="notification relative">
                        <i class="fa-solid fa-bell text-xl text-gray-600 cursor-pointer"></i>
                        <span id="alert-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center hidden"></span>
                    </div>
                    <div class="user-profile flex items-center space-x-2">
                        <i class="fa-solid fa-user-circle text-xl text-gray-600"></i>
                        <span id="user-name" class="font-medium text-gray-700">Loading...</span>
                    </div>
                </div>
            </header>

            <section id="overview" class="page-section active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <a href="#payments" onclick="loadPageAndActivateNav('payments'); return false;" 
                        class="block bg-white p-6 rounded-xl shadow-md flex items-center justify-between transition duration-200 ease-in-out transform hover:scale-[1.02] hover:shadow-lg cursor-pointer">
                        <div>
                            <p class="text-gray-500 text-sm">My Tokens</p>
                            <p id="token-balance" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <i class="fa-solid fa-coins text-4xl text-green-300"></i>
                    </a>
                    <a href="#usage" onclick="loadPageAndActivateNav('usage'); return false;" 
                        class="block bg-white p-6 rounded-xl shadow-md flex items-center justify-between transition duration-200 ease-in-out transform hover:scale-[1.02] hover:shadow-lg cursor-pointer">
                            <div>
                                <p class="text-gray-500 text-sm">Litres Dispensed</p>
                                <p id="litres-dispensed" class="text-3xl font-bold text-blue-600">0L</p>
                            </div>
                            <i class="fa-solid fa-water text-4xl text-blue-300"></i>
                    </a>
                    <a href="#usage" onclick="loadPageAndActivateNav('usage'); return false;" 
                        class="block bg-white p-6 rounded-xl shadow-md flex items-center justify-between transition duration-200 ease-in-out transform hover:scale-[1.02] hover:shadow-lg cursor-pointer">
                            <div>
                                <p class="text-gray-500 text-sm">Daily Usage</p>
                                <p id="daily-usage" class="text-3xl font-bold text-purple-600">0L</p>
                            </div>
                            <i class="fa-solid fa-chart-line text-4xl text-purple-300"></i>
                    </a>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {% include 'dispense_form.html' %} 
                </div>
            </section>


        {% include 'payments.html' %} 
    

            <section id="usage" class="page-section hidden">
                {% include 'usage_details.html' %}
            </section>

            <section id="settings" class="page-section hidden">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Account Settings</h3>
                    <form class="space-y-4">
                        <div>
                            <label for="customer-id" class="block text-sm font-medium text-gray-700">Customer ID</label>
                            <input type="text" id="customer-id" value="WM2024001" disabled class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm">
                        </div>
                        <div>
                            <label for="phone-number" class="block text-sm font-medium text-gray-700">Phone Number</label>
                            <input type="tel" id="phone-number" placeholder="254XXXXXXXXX" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="email-address" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="email-address" placeholder="customer@email.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                        </div>
                        <button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                            Save Changes
                        </button>
                    </form>
                </div>
            </section>
        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global variable for the chart (defined once)
    let usageChart;

    // --- UTILITY FUNCTIONS ---

    //Helper function for card-based navigation
    function loadPageAndActivateNav(pageName){
        navigateTo(pageName);
    }

    // Function to dynamically update the usage chart
    function updateUsageChart(data) {
        if (usageChart) {
            usageChart.data.datasets[0].data = data;
            usageChart.update();
        }
    }
    
    // Function to fetch and display payment history
    async function fetchPaymentHistory() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch('/payments/history', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch payment history');
            }

            const data = await response.json();
            const tableBody = document.getElementById('payment-history-table-body');
            tableBody.innerHTML = ''; 

            if (data.history.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No transactions found.</td></tr>';
                return;
            }

            data.history.forEach(payment => {
                const statusText = payment.status.charAt(0).toUpperCase() + payment.status.slice(1);
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(payment.created_at).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${payment.amount.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">${payment.tokens_purchased}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${payment.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${payment.transaction_id || 'N/A'}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

        } catch (error) {
            console.error('Error fetching payment history:', error);
            document.getElementById('payment-history-table-body').innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading history.</td></tr>';
        }
    }


    // Function to fetch and display user data
async function fetchUserData() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const response = await fetch('/user/me', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/';
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        // Set User Name
        document.getElementById('user-name').textContent = data.username || 'User';

        // --- UNIFIED ADMIN CONTROL START ---
        
        const isAdmin = data.is_admin;
        // Containers: Admin Card in Overview, and Admin Refill Page Nav Button
        const adminCardContainer = document.getElementById('company-water-progress-container'); 
        const adminNavButton = document.getElementById('company-water-card'); 

        // Simplified logic to prevent flickering/clashing of visibility controls
        if (adminCardContainer) {
            adminCardContainer.style.display = isAdmin ? 'block' : 'none';
        }
        if (adminNavButton) {
            adminNavButton.style.display = isAdmin ? 'block' : 'none';
        }
        
        // If the user is an admin, fetch the water tank data
        if (isAdmin) {
            fetchCompanyWaterData();
        }

        // --- UNIFIED ADMIN CONTROL END ---

        // Safely parse token balance
        const tokenBalanceValue = parseFloat(data.token_balance);
        const safeBalance = (isNaN(tokenBalanceValue) || data.token_balance === null) ? '0.00' : tokenBalanceValue.toFixed(2);

        document.getElementById('token-balance').textContent = safeBalance;
        
        // Safely parse litres dispensed
        const litresDispensedValue = parseFloat(data.litres_dispensed);
        const safeLitresDispensed = isNaN(litresDispensedValue) ? '0.00' : litresDispensedValue.toFixed(2);

        document.getElementById('litres-dispensed').textContent = `${safeLitresDispensed}L`;
        
        // Re-check alert status with new balance
        checkTokenBalanceAndAlert();

    } catch (error) {
        console.error('Error fetching user data:', error);
        // Fallback user name and stats
        document.getElementById('user-name').textContent = 'Error';
        document.getElementById('token-balance').textContent = 'E R R';
    }
}
    
    // Function to fetch and display company water level
// ----------------------------------------------------
// Fetch Company Water Data
// ----------------------------------------------------
async function fetchCompanyWaterData() {
    const token = localStorage.getItem('token');
    if (!token) return;

    // First, check if the admin elements are set to be visible (i.e., display != 'none')
    const companyWaterCardContainer = document.getElementById('company-water-progress-container');
    if (companyWaterCardContainer && companyWaterCardContainer.style.display === 'none') {
        return; // Not an admin or already hidden by fetchUserData, so skip fetch
    }

    try {
        const response = await fetch('/admin/tank_status', { // <-- Admin API endpoint
            method: 'GET',
            headers: { 
                'Authorization': `Bearer ${token}` 
            }
        });

        const data = await response.json();
        
        if (response.ok) {
            const waterLevelEl = document.getElementById('company-water-level');
            const progressBar = document.getElementById('company-progress-bar');
            const lastUpdatedEl = document.getElementById('company-last-updated');

            const level = parseFloat(data.level);
            const capacity = parseFloat(data.capacity);
            
            const percentage = (level / capacity) * 100;
            const safePercentage = Math.min(100, Math.max(0, percentage)).toFixed(2);

            if (waterLevelEl) waterLevelEl.textContent = `${level.toFixed(2)}L / ${capacity.toFixed(2)}L`;
            if (progressBar) progressBar.style.width = `${safePercentage}%`;
            if (lastUpdatedEl) lastUpdatedEl.textContent = new Date(data.last_updated).toLocaleString();

        } else if (response.status === 403 || response.status === 401) {
            // Not Admin or unauthorized - hide card if the API confirms lack of access
            if (companyWaterCardContainer) companyWaterCardContainer.style.display = 'none';
        } else {
            console.error('Failed to fetch tank status:', data.error || 'Server error');
        }

    } catch (error) {
        console.error('Network error fetching tank status:', error);
    }
}


// ----------------------------------------------------
// Admin Refill Handlers
// ----------------------------------------------------
function showRefillMessage(message, type) {
    const msgDiv = document.getElementById('refill-message');
    if (msgDiv) {
        msgDiv.textContent = message;
        msgDiv.className = `mt-4 text-center text-sm ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
        msgDiv.classList.remove('hidden');
    }
}

async function handleRefillTank(e) {
    e.preventDefault();
    const token = localStorage.getItem('token');
    const refillAmountInput = document.getElementById('refill-amount');
    const refillAmount = refillAmountInput ? refillAmountInput.value : 0;
    const refillBtn = document.getElementById('refill-button');

    if (parseFloat(refillAmount) <= 0) {
        showRefillMessage('Refill amount must be greater than zero.', 'error');
        return;
    }

    refillBtn.disabled = true;
    refillBtn.textContent = 'Refilling...';
    
    const data = { amount: parseFloat(refillAmount) };

    try {
        const response = await fetch('/admin/refill_tank', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();

        if (response.ok) {
            showRefillMessage(result.msg || `Tank refilled by ${refillAmount}L successfully!`, 'success');
            document.getElementById('refill-form').reset();
            fetchCompanyWaterData(); // Refresh the progress bar
        } else if (response.status === 401 || response.status === 403) {
            showRefillMessage(result.error || 'Authentication failed or not authorized.', 'error');
            if (response.status === 401) logout();
        } else {
            showRefillMessage(result.error || 'Refill failed due to a server error.', 'error');
        }

    } catch (error) {
        console.error('Network error during refill:', error);
        showRefillMessage('A network error occurred. Check your connection.', 'error');
    } finally {
        refillBtn.disabled = false;
        refillBtn.textContent = 'Refill Tank';
    }
}

    //Logic for Dispense in browser:
    const LITRES_PER_TOKEN_RATE = 1.0; // as defined in config.py (these values must match)

    async function handleDispense() {
    const token = localStorage.getItem('token');
    const form = document.getElementById('dispense-form');
    const litresInput = document.getElementById('litres-to-dispense');
    const dispenseButton = document.getElementById('dispense-button');
    const messageDiv = document.getElementById('dispense-message');
    
    const requestedLitres = parseFloat(litresInput.value);

    if (isNaN(requestedLitres) || requestedLitres <= 0) {
        alert("Please enter a valid positive amount of litres.");
        return;
    }

    dispenseButton.disabled = true;
    dispenseButton.textContent = 'Dispensing...';
    messageDiv.classList.add('hidden');

    try {
        const response = await fetch('/water/dispense', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ litres: requestedLitres })
        });

        const data = await response.json();
        
        messageDiv.textContent = data.msg;
        messageDiv.classList.remove('hidden');

        if (response.ok) {
            messageDiv.className = 'mt-4 text-center text-sm text-green-600';
            
            // CRITICAL: Refresh all dashboard data after success
            fetchUserData(); 
            fetchCompanyWaterData();
            fetchUsageHistory();
            litresInput.value = ''; // Clear input on success

            const dailyUsageEl = document.getElementById('daily-usage')
            if (dailyUsageEl){
                dailyUsageEl.textContent = `${requestedLitres.toFixed(2)}L`;
            }


        } else {
            messageDiv.className = 'mt-4 text-center text-sm text-red-600';
        }

    } catch (error) {
        console.error('Dispense network error:', error);
        messageDiv.textContent = 'A network error occurred while dispensing.';
        messageDiv.className = 'mt-4 text-center text-sm text-red-600';
        messageDiv.classList.remove('hidden');
    } finally {
        dispenseButton.disabled = false;
        dispenseButton.textContent = 'Dispense Water';
        // Ensure the tokens required message is reset
        document.getElementById('tokens-required-msg').textContent = 'Required Tokens: 0.00';
    }
    }

    // Function to update required tokens dynamically
    function updateTokensRequired() {
    const litresInput = document.getElementById('litres-to-dispense');
    const tokensMsg = document.getElementById('tokens-required-msg');
    
    const requestedLitres = parseFloat(litresInput.value);

    if (requestedLitres > 0) {
        const tokensRequired = requestedLitres / LITRES_PER_TOKEN_RATE;
        tokensMsg.textContent = `Required Tokens: ${tokensRequired.toFixed(2)}`;
    } else {
        tokensMsg.textContent = 'Required Tokens: 0.00';
    }
    }

    //fetch Usage of tokens history:

    async function fetchUsageHistory() {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
        const response = await fetch('/water/usage/history', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to fetch usage history');
        
        const data = await response.json();
        const history = data.history;
        
        // Prepare data for the chart (last 7 records)
        const chartData = history.slice(-7).map(record => record.litres_dispensed);
        
        // Fill up with zeros if less than 7 data points
        while (chartData.length < 7) {
            chartData.unshift(0);
        }

        updateUsageChart(chartData);

        const tableBody = document.getElementById('usage-history-table-body');
        tableBody.innerHTML = '';

            if (history.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No usage records found.</td></tr>';
                return;
            }

        // Reverse history to show most recent at the top
        [...history].reverse().forEach(record => {
            const row = `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(record.created_at).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">${record.litres_dispensed.toFixed(2)} L</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">${record.tokens_used.toFixed(2)}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });


    } catch (error) {
        console.error('Error fetching usage history:', error);
        // Fallback for chart and table on error: 
        updateUsageChart([0, 0, 0, 0, 0, 0, 0]);
        document.getElementById('usage-history-table-body').innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Error loading usage history.</td></tr>';
    }
}

    function checkTokenBalanceAndAlert() {
        const tokenBalanceElement = document.getElementById('token-balance');
        const alertBadge = document.getElementById('alert-badge');
        if (tokenBalanceElement && alertBadge) {
            const balance = parseFloat(tokenBalanceElement.textContent.replace(/[^\d.]/g, '')); 
            
            if (balance < 10) {
                alertBadge.textContent = '1';
                alertBadge.classList.remove('hidden');
                document.querySelector('.notification i').classList.add('text-red-500');
            } else {
                alertBadge.classList.add('hidden');
                document.querySelector('.notification i').classList.remove('text-red-500');
            }
        }
    }

    // Navigation functionality (kept simple)
    function navigateTo(pageToShow) {
        // Hide all page sections
        document.querySelectorAll('.page-section').forEach(section => {
            section.classList.add('hidden');
            section.classList.remove('active');
        });

        // Show the requested page section
        const activeSection = document.getElementById(pageToShow);
        if (activeSection) {
            activeSection.classList.remove('hidden');
            activeSection.classList.add('active');
        }


        // Update navigation button active state
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        const activeNavBtn = document.querySelector(`.nav-btn[data-page="${pageToShow}"]`);
        if (activeNavBtn) {
            activeNavBtn.classList.add('active');
        }


        // Load data specific to the page immediately on navigation
        if (pageToShow === 'payments') {
            fetchPaymentHistory();
        } else if (pageToShow === 'usage') {
            fetchUsageHistory();
        }
    }

    // --- MAIN INITIALIZATION BLOCK ---
    
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/'; // Redirect to login
            return;
        }

        // 1. Bind navigation links
        document.querySelectorAll('.nav-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                event.preventDefault(); 
                const pageToShow = event.currentTarget.dataset.page;
                navigateTo(pageToShow);
            });
        });

        // 2. Bind Dispense Form logic
        const dispenseForm = document.getElementById('dispense-form');
        if (dispenseForm) {
            dispenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleDispense();
            });
            // Also bind to input change for dynamic token calculation
            document.getElementById('litres-to-dispense').addEventListener('input', updateTokensRequired);
        }


        // 3. Bind Payment Form Submission Logic
        const purchaseForm = document.getElementById('token-purchase-form');
        if (purchaseForm) {
            purchaseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const amountInput = document.getElementById('purchase-amount');
                const amount = parseFloat(amountInput.value);
                const payButton = document.getElementById('pay-button');

                if (amount < 10) {
                    alert("Minimum purchase amount is 10 Ksh.");
                    return;
                }

                payButton.disabled = true;
                payButton.textContent = 'Processing...';

                try {
                    const response = await fetch('/payments/buy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ amount: amount })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(`Success! ${data.tokens_purchased} tokens added. New balance: ${data.new_balance.toFixed(2)}`);
                        amountInput.value = ''; 
                        
                        // CRITICAL: Refresh the dashboard data
                        fetchUserData(); 
                        fetchPaymentHistory(); 
                        checkTokenBalanceAndAlert();
                    } else {
                        alert(`Payment Failed: ${data.msg || 'An error occurred.'}`);
                    }
                } catch (error) {
                    console.error('Payment network error:', error);
                    alert('A network error occurred while processing the payment.');
                } finally {
                    payButton.disabled = false;
                    payButton.textContent = 'Purchase Tokens';
                }
            });
        }


        // 4. Initialize Usage Chart
        const usageChartElement = document.getElementById('usage-chart');
        if (usageChartElement) {
            const ctx = usageChartElement.getContext('2d');
            usageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
                    datasets: [{
                        label: 'Water Usage (Litres)',
                        data: [0, 0, 0, 0, 0, 0, 0], // Initial data will be replaced by fetchUsageHistory
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false }, title: { display: false } }
                }
            });
        }
        
        // 5. Initial Data Load
        fetchUserData();
        fetchCompanyWaterData();
        // Payments and Usage history will be fetched when their sections are navigated to, 
        // but we can fetch them once on load if their data is needed elsewhere (like for the overview chart).
        fetchUsageHistory(); 
    });
</script>
</body>
</html>